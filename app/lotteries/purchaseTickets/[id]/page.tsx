"use client";

import NumberPicker from "@/components/NumberPicker";
import { fetchLotteryById } from "@/redux/slices/lotterySlice";
import { createAffiliateTransaction } from "@/redux/slices/retailerSlice";
import {
	addToCart,
	clearCart,
	fetchTicketsByLotteryId,
	purchaseTicket,
	recordTransaction,
	removeFromCart,
} from "@/redux/slices/userSlice";
import { getWalletBalance, setBalance } from "@/redux/slices/walletSlice";
import { AppDispatch, RootState } from "@/redux/store";
import { useParams, useRouter, useSearchParams } from "next/navigation";
import { Suspense, useEffect, useState } from "react";
import toast from "react-hot-toast";
import { FaDice, FaMinus, FaPencilAlt, FaPlus } from "react-icons/fa";
import { MdDelete } from "react-icons/md";
import { useDispatch, useSelector } from "react-redux";

interface TicketOption {
	id: string;
	type: "random" | "custom";
	number: string;
	price: number;
}

function PurchaseTicketsContent() {
	const [activeTab, setActiveTab] = useState<"random" | "custom">("random");
	const [quantity, setQuantity] = useState(1);
	const [customNumber, setCustomNumber] = useState<string>("");
	const [selectedTickets, setSelectedTickets] = useState<TicketOption[]>([]);
	const { balance } = useSelector((state: RootState) => state.wallet);
	const [lotteryDetails, setLotteryDetails] = useState<any>({});
	// const [soldTickets, setSoldTickets] = useState<any>([]);
	const { profile: retailer } = useSelector(
		(state: RootState) => state.retailer
	) as any;

	const [selectedSuggestion, setSelectedSuggestion] = useState<string | null>(
		null
	);

	const {
		authUser,
		cartTickets,
		purchasedTickets: soldTickets,
	} = useSelector((state: RootState) => state.user);

	const router = useRouter();
	const dispatch = useDispatch<AppDispatch>();

	const params = useParams();
	const { id } = params;
	console.log("params", params);
	const query = useSearchParams();
	const affiliate_id = query.get("affiliate_id");

	console.log("lotteryDetails", lotteryDetails);

	useEffect(() => {
		if (id) {
			dispatch(fetchLotteryById(id))
				.unwrap()
				.then((data) => {
					setLotteryDetails(data);
					setNumbers(Array(data.digit_length).fill(""));
				})
				.catch((error) => {
					console.error("Failed to fetch lottery:", error);
				});
			dispatch(fetchTicketsByLotteryId(id))
				.unwrap()
				.then((data) => {
					console.log("Sold Tickets fetched successfully", data);
				})
				.catch((error) => {
					console.error("Failed to fetch tickets:", error);
				});
		}
		dispatch(getWalletBalance());
		setSelectedTickets(cartTickets);
	}, [dispatch, id, cartTickets]);

	const [numbers, setNumbers] = useState<string[]>([]);

	const [suggestions, setSuggestions] = useState<string[]>([]);

	const handleNumberChange = (index: number, value: string) => {
		const newNumbers = [...numbers];
		newNumbers[index] = value;
		setNumbers(newNumbers);
		setCustomNumber(newNumbers.join(""));
	};

	const generateRandomTicket = () => {
		let randomNum = Math.random()
			.toString()
			.slice(2, 2 + lotteryDetails.digit_length);

		while (randomNum[0] === "0") {
			randomNum = Math.random()
				.toString()
				.slice(2, 2 + lotteryDetails.digit_length);
		}

		if (
			soldTickets.some(
				(data: any) => data.ticket_number === parseInt(randomNum)
			) ||
			selectedTickets.some((ticket) => ticket.number === randomNum)
		) {
			toast.error("Ticket not available");
			return "";
		}
		return randomNum;
	};

	const handleQuantityChange = (increment: boolean) => {
		setQuantity((prev) => (increment ? prev + 1 : Math.max(1, prev - 1)));
	};

	// const soldTicketsNumbers = soldTickets.map(
	// 	(ticket) => ticket.ticket_number
	// );
	// console.log({ soldTicketsNumbers });

	const getSuggestedTickets = (requestedNumber: string): string[] => {
		// Get all unavailable numbers
		const unavailableNumbers = [
			...selectedTickets.map((ticket) => ticket.number),
			...soldTickets.map((data: any) => data.ticket_number.toString()),
		];

		console.log({ unavailableNumbers });

		const suggestions: string[] = [];
		const requestedNum = parseInt(requestedNumber);
		const digitLength = lotteryDetails.digit_length;

		// Generate variations
		const variations = [
			// Increment
			...Array(5)
				.fill(0)
				.map((_, i) =>
					(requestedNum + i + 1).toString().padStart(digitLength, "1")
				),
			// Decrement
			...Array(5)
				.fill(0)
				.map((_, i) =>
					(requestedNum - i - 1).toString().padStart(digitLength, "1")
				),
			// Pattern match (keep first/last digits)
			requestedNumber[0] +
				Math.random()
					.toString()
					.slice(2, digitLength + 1),
			Math.random().toString().slice(2, digitLength) +
				requestedNumber[digitLength - 1],
		];

		// Filter valid suggestions
		for (const num of variations) {
			if (
				num.length === digitLength &&
				num[0] !== "0" && // No leading zeros
				!unavailableNumbers.includes(num) &&
				!suggestions.includes(num)
			) {
				suggestions.push(num);
				if (suggestions.length >= 5) break;
			}
		}

		return suggestions;
	};

	const addRandomTickets = () => {
		const newTickets = [];

		for (let i = 0; i < quantity; i++) {
			const randomNumber = generateRandomTicket();

			if (randomNumber === "") {
				toast.error("Failed to generate valid ticket");
				continue;
			}

			newTickets.push({
				id: Math.random().toString(),
				type: "random" as const,
				number: randomNumber,
				price: lotteryDetails.ticket_price,
			});
			dispatch(
				addToCart({
					id: Math.random().toString(),
					type: "random" as const,
					number: randomNumber,
					price: lotteryDetails.ticket_price,
				})
			);
		}

		if (newTickets.length > 0) {
			setSelectedTickets([...selectedTickets, ...newTickets]);

			toast.success(`Added ${newTickets.length} tickets`);
		}

		setQuantity(1);
	};

	// do not add tickets if they are already selected or purchased
	const addCustomTicket = () => {
		if (customNumber.length === lotteryDetails.digit_length) {
			if (
				selectedTickets.some((ticket) => ticket.number === customNumber)
			) {
				toast.error("Ticket already selected");
				setSuggestions(getSuggestedTickets(customNumber));
				return;
			}

			if (
				soldTickets.some(
					(data: any) =>
						data.lottery_id.name === lotteryDetails.name &&
						data.ticket_number === parseInt(customNumber)
				)
			) {
				toast.error("Ticket not available");
				setSuggestions(getSuggestedTickets(customNumber));
				return;
			}

			setSelectedTickets([
				...selectedTickets,
				{
					id: Math.random().toString(),
					type: "custom",
					number: customNumber,
					price: lotteryDetails.ticket_price,
				},
			]);
			setCustomNumber("");
			setSuggestions([]);
			setNumbers(Array(lotteryDetails.digit_length).fill(""));
			dispatch(
				addToCart({
					id: Math.random().toString(),
					type: "custom",
					number: customNumber,
					price: lotteryDetails.ticket_price,
				})
			);
			toast.success("Added 1 ticket");
		}
	};

	const totalPrice = selectedTickets.reduce(
		(sum, ticket) => sum + ticket.price,
		0
	);

	console.log("balance", balance);
	console.log("totalPrice", totalPrice);
	console.log("selectedTickets", selectedTickets);
	console.log("cartTickets", cartTickets);
	console.log("retailer_id", retailer?._id);
	// console.log("transactionId", transactionId);

	const ticketNumbers = selectedTickets.map((ticket) => ticket.number);
	console.log("ticketNumbers", ticketNumbers);

	const handleCheckout = async () => {
		if (!authUser) {
			toast.error("Please login to purchase tickets");
			router.push("/login");
			return;
		}

		if (balance < totalPrice) {
			toast.error("Insufficient balance");
			router.push(`/credit/?affiliate_id=${retailer?.uniqueId}`);
			return;
		}

		const transaction = await dispatch(
			recordTransaction({
				amount: totalPrice,
				transaction_type: "purchase",
				lottery_id: lotteryDetails?._id,
				operation: "subtract",
				ticket_numbers: ticketNumbers,
			})
		).unwrap();

		dispatch(setBalance(transaction.updatedBalance));

		if (affiliate_id) {
			// create affiliate transaction
			dispatch(
				createAffiliateTransaction({
					retailerId: retailer?._id,
					transactionId: transaction.transaction?._id,
					amount: totalPrice,
				})
			)
				.unwrap()
				.then((data) => {
					console.log(
						"Affiliate Transaction created successfully",
						data
					);
				})
				.catch((error) => {
					console.error(
						"Failed to create affiliate transaction",
						error
					);
				});
		}

		dispatch(
			purchaseTicket({
				tickets: ticketNumbers,
				lottery_id: lotteryDetails._id,
			})
		)
			.unwrap()
			.then(() => {
				console.log("purchaseTicket Success");
				toast.success("Tickets Purchased!");
				setSelectedTickets([]);
				dispatch(clearCart());
			})
			.catch((error) => {
				console.error("Error in purchaseTicket", error);
				// toast.error("Transaction Failed");
			});
	};

	const deleteTicket = (ticket: TicketOption) => {
		setSelectedTickets(selectedTickets.filter((t) => t.id !== ticket.id));
		dispatch(removeFromCart(ticket.id));
	};

	return (
		<div className="min-h-screen py-16 bg-gray-100 md:pb-0">
			<div className="max-w-7xl mx-auto h-full p-4">
				{/* Lottery Details Header */}
				<div className="bg-white rounded-lg shadow-md p-6 mb-6">
					<h1 className="text-3xl font-bold text-gray-800 mb-2">
						{lotteryDetails.name}
					</h1>
					<div className="flex gap-2 justify-between">
						<p className="text-gray-600 text-xs">
							Ticket Price:{" "}
							<span className="font-bold">
								â‚¹ {lotteryDetails.ticket_price}
							</span>
						</p>
						<p className="text-gray-600 text-xs">
							Draw Date:{" "}
							<span className="font-bold">
								{lotteryDetails.draw_date}
							</span>
						</p>
					</div>
				</div>

				{/* Tab Selection */}
				<div className="bg-white rounded-lg shadow-md overflow-hidden mb-6">
					<div className="flex border-b">
						<button
							className={`flex-1 p-4 ${
								activeTab === "random"
									? "bg-blue-500 text-white"
									: "text-gray-600"
							}`}
							onClick={() => setActiveTab("random")}
						>
							<FaDice className="inline mr-2" /> Random Tickets
						</button>
						<button
							className={`flex-1 p-4 ${
								activeTab === "custom"
									? "bg-blue-500 text-white"
									: "text-gray-600"
							}`}
							onClick={() => setActiveTab("custom")}
						>
							<FaPencilAlt className="inline mr-2" /> Choose your
							own number
						</button>
					</div>

					<div className="p-6">
						{activeTab === "random" ? (
							<div className="space-y-4">
								<div className="flex items-center justify-center space-x-4">
									<button
										className="p-2 rounded-full bg-gray-200"
										onClick={() =>
											handleQuantityChange(false)
										}
									>
										<FaMinus />
									</button>
									<span className="text-2xl font-bold">
										{quantity}
									</span>
									<button
										className="p-2 rounded-full bg-gray-200"
										onClick={() =>
											handleQuantityChange(true)
										}
									>
										<FaPlus />
									</button>
								</div>
								<button
									className="w-full bg-blue-500 text-white py-3 rounded-lg"
									onClick={addRandomTickets}
								>
									Generate Random Tickets
								</button>
							</div>
						) : (
							<div className="space-y-4">
								<div className="flex items-center justify-center space-x-4">
									{Array.from(
										{ length: lotteryDetails.digit_length },
										(_, i) => (
											<NumberPicker
												key={i}
												index={i}
												value={numbers[i]}
												onChange={handleNumberChange}
												totalDigits={
													lotteryDetails.digit_length
												}
											/>
										)
									)}
								</div>

								{suggestions.length > 0 && (
									<div className="flex flex-col gap-2 justify-center items-center">
										<p className="text-gray-600">
											Ticket not available. Try these
											numbers:
										</p>
										<div className="flex flex-row flex-wrap mt-2 gap-2">
											{suggestions.map((num) => (
												<button
													key={num}
													className={`block text-center px-2 py-1 rounded transition-colors
														${
															selectedSuggestion ===
															num
																? "bg-blue-500 text-white"
																: "bg-gray-100 hover:bg-blue-400 hover:text-white"
														}`}
													onClick={() => {
														setSelectedSuggestion(
															num
														);
														setCustomNumber(num);
													}}
												>
													{num}
												</button>
											))}
										</div>
									</div>
								)}

								<button
									className="w-full bg-blue-500 text-white py-3 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed"
									onClick={addCustomTicket}
									disabled={
										customNumber.length !==
										lotteryDetails.digit_length
									}
								>
									Add Custom Ticket
								</button>
							</div>
						)}
					</div>
				</div>

				{/* Selected Tickets */}
				<div className="bg-white rounded-lg shadow-md p-6">
					<h2 className="text-2xl font-bold mb-4">
						Selected Tickets
					</h2>
					{selectedTickets.length === 0 ? (
						<p className="text-gray-600">No tickets selected yet</p>
					) : (
						<div className="space-y-4">
							{selectedTickets.map((ticket) => (
								<div
									key={ticket.id}
									className="flex justify-between items-center p-3 bg-gray-50 rounded"
								>
									<span>{ticket.number}</span>
									<span>â‚¹{ticket.price}</span>
									<button
										className="p-1 rounded-full"
										onClick={() => deleteTicket(ticket)}
									>
										<MdDelete className="text-red-500 size-6" />
									</button>
								</div>
							))}
							<div className="border-t pt-4">
								<div className="flex justify-between font-bold">
									<span>Total:</span>
									<span>â‚¹{totalPrice}</span>
								</div>
								<button
									className="w-full mt-4 bg-green-500 text-white py-3 rounded-lg"
									onClick={handleCheckout}
								>
									Proceed to Checkout
								</button>
							</div>
						</div>
					)}
				</div>
			</div>
		</div>
	);
}

export default function PurchaseTicketsPage() {
	return (
		<Suspense fallback={<div>Loading...</div>}>
			<PurchaseTicketsContent />
		</Suspense>
	);
}
